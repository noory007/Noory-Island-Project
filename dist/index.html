<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/IdeaSpaceVR/aframe-particle-system-component@1.0.2/dist/aframe-particle-system-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/super-hands@4.0.5/dist/super-hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/fernandojsg/aframe-teleport-controls@v4.3.2/dist/aframe-teleport-controls.min.js"></script>
    <title>My Island</title>

    <script>
      // safe-gltf-model component to avoid GLTFLoader extension issues
      AFRAME.registerComponent("safe-gltf-model", {
        schema: { type: "selector" },
        init: function () {
          const el = this.el;
          const src = this.data;
          if (!src) return;

          // Clone the glTF model asset (prevents reuse issues)
          const asset = src.cloneNode();
          const url = asset.getAttribute("src");

          // Load GLTF manually with patched parser to ignore KHR_materials_pbrSpecularGlossiness
          const loader = new THREE.GLTFLoader();

          // Patch parser to skip unknown extensions gracefully
          loader.parse = (function (originalParse) {
            return function (data, path, onLoad, onError) {
              try {
                originalParse.call(this, data, path, onLoad, onError);
              } catch (e) {
                console.warn("GLTFLoader parse warning:", e);
                onLoad(null); // fallback
              }
            };
          })(loader.parse);

          loader.load(
            url,
            (gltf) => {
              if (gltf && gltf.scene) {
                el.setObject3D("mesh", gltf.scene);
              }
            },
            undefined,
            (error) => {
              console.error("GLTFLoader error loading model:", error);
            }
          );
        },
        remove: function () {
          this.el.removeObject3D("mesh");
        },
      });
    </script>
  </head>
  <body>
    <a-scene
      cursor="rayOrigin: mouse"
      raycaster="objects: .clickable, .clickable1"
    >
      <a-assets>
        <audio id="elk-sound" src="/audio/elk.mp3" preload="auto"></audio>
        <audio id="owl-sound" src="/audio/owl.mp3" preload="auto"></audio>
        <audio id="birds-sound" src="/audio/birds.mp3" preload="auto"></audio>
        <audio id="woman-sound" src="/audio/woman.mp3" preload="auto"></audio>

        <a-asset-item
          id="forest-floor"
          src="/models/forest-floor.glb"
        ></a-asset-item>
        <a-asset-item
          id="ladyflowers"
          src="/models/ladyflowers.glb"
        ></a-asset-item>
        <a-asset-item
          id="fantasy-house"
          src="/models/fantasy-house.glb"
        ></a-asset-item>
        <a-asset-item
          id="mushroom-house"
          src="/models/mushroom-house.glb"
        ></a-asset-item>
        <a-asset-item id="sky-house" src="/models/sky-house.glb"></a-asset-item>
        <a-asset-item id="elk" src="/models/elk.glb"></a-asset-item>
        <a-asset-item id="castle" src="/models/castle.glb"></a-asset-item>
        <a-asset-item id="owl" src="/models/owl.glb"></a-asset-item>
        <a-asset-item
          id="island-red-sky"
          src="/models/island-red-sky.glb"
        ></a-asset-item>
        <a-asset-item
          id="winter-island"
          src="/models/winter-island.glb"
        ></a-asset-item>
        <a-asset-item
          id="stone-floor"
          src="/models/stone-floor.glb"
        ></a-asset-item>
      </a-assets>

      <a-sky
        src="/images/stars-sky.jpg"
        rotation="0 0 0"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 60000; easing: linear"
      ></a-sky>

      <a-entity
        safe-gltf-model="#forest-floor"
        position="-5 -1 -2"
        scale="5 5 5"
        rotation="0 -90 0"
      ></a-entity>
      <a-entity
        safe-gltf-model="#island-red-sky"
        position="0 -9 0"
        scale="1 1 1"
        rotation="0 -90 0"
      ></a-entity>
      <a-entity
        safe-gltf-model="#sky-house"
        position="-14 4 3"
        scale="0.04 0.04 0.04"
        rotation="0 45 0"
      ></a-entity>
      <a-entity
        safe-gltf-model="#winter-island"
        position="-20 -1 8"
        scale="0.5 0.5 0.5"
        rotation="10 5 0"
      ></a-entity>

      <a-entity
        id="elk-click"
        class="clickable"
        elk-action
        safe-gltf-model="#elk"
        position="-12 0 8"
        scale="1 1 1"
        rotation="0 45 0"
        sound="src: #elk-sound; autoplay: false; on: click"
      ></a-entity>

      <a-entity
        safe-gltf-model="#stone-floor"
        position="2 0 0"
        scale="5 5 5"
        rotation="5 5 2"
        class="floor"
      ></a-entity>
      <a-entity
        safe-gltf-model="#stone-floor"
        position="5 1 -13"
        scale="12 12 12"
        rotation="5 5 18"
        class="floor"
      ></a-entity>
      <a-entity
        safe-gltf-model="#stone-floor"
        position="-2 -0.2 4"
        scale="5 5 5"
        rotation="0 -90 0"
        class="floor"
      ></a-entity>

      <a-entity
        safe-gltf-model="#castle"
        position="12 5 -15"
        scale="1.5 1.5 1.5"
        rotation="18 5 2"
      ></a-entity>

      <a-entity
        id="owl-click"
        class="clickable"
        owl-action
        safe-gltf-model="#owl"
        position="20 5 -5"
        scale="2 2 2"
        rotation="0 -90 0"
        sound="src: #owl-sound; autoplay: false; on: click"
      ></a-entity>

      <a-entity
        id="ladyflowers-click"
        ladyflowers-action
        class="clickable1"
        safe-gltf-model="#ladyflowers"
        position="-28 -4 0"
        scale="0.03 0.03 0.03"
        rotation="0 -240 0"
        sound="src: #woman-sound; autoplay: false; on: click"
      ></a-entity>

      <a-entity
        safe-gltf-model="#fantasy-house"
        position="-5 0.1 0"
        scale="7 7 7"
        rotation="5 -5 0"
      ></a-entity>
      <a-entity
        safe-gltf-model="#mushroom-house"
        position="5 0 3"
        scale="25 25 25"
        rotation="0 -90 0"
      ></a-entity>

      <a-entity
        camera
        position="-7 1.6 13.5"
        look-controls
        wasd-controls
      ></a-entity>

      <!-- Working Teleportation Setup -->
      <a-entity
        hand-controls="hand: left"
        teleport-controls="button: trigger; collisionEntities: .floor;"
        raycaster="objects: .clickable, .clickable1"
      ></a-entity>
      <a-entity
        laser-controls="hand: right"
        raycaster="objects: .clickable, .clickable1"
      ></a-entity>

      <!-- Ambient birds sound entity -->
      <a-entity
        id="birds-ambient"
        sound="src: #birds-sound; autoplay: false; loop: true; volume: 0.3"
      ></a-entity>
    </a-scene>

    <script>
      // Interaction components (keep your animations and logging)
      AFRAME.registerComponent("elk-action", {
        init: function () {
          const el = this.el;

          el.addEventListener("click", () => {
            console.log("Elk clicked!");
            el.setAttribute("animation__move", {
              property: "position",
              to: "-12 0 15",
              dur: 2000,
              easing: "easeInOutQuad",
            });

            el.setAttribute("animation__rotate", {
              property: "rotation",
              to: "0 360 0",
              dur: 2000,
              easing: "easeInOutQuad",
            });

            // sound plays automatically via sound component, no need to call play()
          });
        },
      });

      AFRAME.registerComponent("owl-action", {
        init: function () {
          const el = this.el;
          el.addEventListener("click", () => {
            console.log("Owl clicked!");
            el.setAttribute("animation__move", {
              property: "position",
              to: "20 8 -5",
              dur: 2000,
              easing: "easeInOutQuad",
            });
            el.setAttribute("animation__rotate", {
              property: "rotation",
              to: "0 360 0",
              dur: 2000,
              easing: "easeInOutQuad",
            });
          });
        },
      });

      AFRAME.registerComponent("ladyflowers-action", {
        init: function () {
          const el = this.el;
          el.addEventListener("click", () => {
            console.log("Ladyflowers clicked!");
            el.setAttribute("animation__move", {
              property: "position",
              to: "-28 -2 0",
              dur: 2000,
              easing: "easeInOutQuad",
            });
            el.setAttribute("animation__rotate", {
              property: "rotation",
              to: "0 -360 0",
              dur: 2000,
              easing: "easeInOutQuad",
            });
          });
        },
      });

      // Play birds ambient sound on first user click (required by autoplay policies)
      document.addEventListener("click", function playBirdsSound() {
        const birdsAmbient = document.querySelector("#birds-ambient");
        if (birdsAmbient && birdsAmbient.components.sound) {
          birdsAmbient.components.sound.playSound();
        }
        document.removeEventListener("click", playBirdsSound);
      });
    </script>
  </body>
</html>
