<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Island (VR Ready)</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/super-hands@4.0.5/dist/super-hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/fernandojsg/aframe-teleport-controls@v4.3.2/dist/aframe-teleport-controls.min.js"></script>

    <script>
      // safe-gltf-model component to load models without GLTFLoader errors
      AFRAME.registerComponent("safe-gltf-model", {
        schema: { type: "selector" },
        init: function () {
          const el = this.el;
          const src = this.data;
          if (!src) return;
          const url = src.getAttribute("src");
          const loader = new THREE.GLTFLoader();

          // patch parse errors
          const originalParse = loader.parse.bind(loader);
          loader.parse = (data, path, onLoad, onError) => {
            try {
              originalParse(data, path, onLoad, onError);
            } catch (e) {
              console.warn("GLTFLoader parse warning:", e);
              onLoad(null);
            }
          };

          loader.load(
            url,
            (gltf) => {
              if (gltf && gltf.scene) {
                el.setObject3D("mesh", gltf.scene);
                el.emit("model-loaded");
              }
            },
            undefined,
            (err) => console.error("GLTF load error:", err)
          );
        },
        remove: function () {
          this.el.removeObject3D("mesh");
        },
      });
    </script>
  </head>

  <body>
    <a-scene cursor="rayOrigin: mouse" raycaster="objects: .clickable">
      <a-assets>
        <audio id="elk-sound" src="/audio/elk.mp3" preload="auto"></audio>
        <audio id="owl-sound" src="/audio/owl.mp3" preload="auto"></audio>
        <audio id="birds-sound" src="/audio/birds.mp3" preload="auto"></audio>
        <audio id="woman-sound" src="/audio/woman.mp3" preload="auto"></audio>

        <a-asset-item id="elk" src="/models/elk.glb"></a-asset-item>
        <a-asset-item id="owl" src="/models/owl.glb"></a-asset-item>
        <a-asset-item
          id="ladyflowers"
          src="/models/ladyflowers.glb"
        ></a-asset-item>
        <a-asset-item
          id="stone-floor"
          src="/models/stone-floor.glb"
        ></a-asset-item>
      </a-assets>

      <a-sky color="#222"></a-sky>

      <!-- Clickable Entities with Sound + Animation -->
      <a-entity
        id="elk-click"
        class="clickable"
        position="-1 0 -3"
        scale="1 1 1"
        safe-gltf-model="#elk"
        sound="src: #elk-sound; autoplay: false"
      ></a-entity>

      <a-entity
        id="owl-click"
        class="clickable"
        position="1 1 -3"
        scale="1 1 1"
        safe-gltf-model="#owl"
        sound="src: #owl-sound; autoplay: false"
      ></a-entity>

      <a-entity
        id="ladyflowers-click"
        class="clickable"
        position="0 0 -5"
        scale="0.05 0.05 0.05"
        safe-gltf-model="#ladyflowers"
        sound="src: #woman-sound; autoplay: false"
      ></a-entity>

      <!-- Floor for teleport -->
      <a-entity
        safe-gltf-model="#stone-floor"
        class="floor"
        position="0 0 0"
        scale="5 5 5"
      ></a-entity>

      <!-- Ambient birds sound -->
      <a-entity
        id="birds-ambient"
        sound="src: #birds-sound; autoplay: false; loop: true; volume: 0.3"
      ></a-entity>

      <!-- VR Setup: camera + controllers with teleport & laser -->
      <a-entity id="cameraRig" position="0 1.6 0">
        <a-camera></a-camera>

        <!-- Left hand for teleport -->
        <a-entity
          hand-controls="hand: left"
          teleport-controls="button: trigger; collisionEntities: .floor; cameraRig: #cameraRig"
        ></a-entity>

        <!-- Right hand for laser click interaction -->
        <a-entity
          hand-controls="hand: right"
          laser-controls
          raycaster="objects: .clickable"
        ></a-entity>
      </a-entity>
    </a-scene>

    <script>
      const elk = document.querySelector("#elk-click");
      const owl = document.querySelector("#owl-click");
      const lady = document.querySelector("#ladyflowers-click");
      const birds = document.querySelector("#birds-ambient");

      // Start birds ambient sound on first interaction
      window.addEventListener(
        "click",
        () => {
          if (birds.components.sound) birds.components.sound.playSound();
        },
        { once: true }
      );

      function animateAndSound(ent, posTo, rotTo) {
        ent.setAttribute("animation__move", {
          property: "position",
          to: posTo,
          dur: 1500,
          easing: "easeInOutQuad",
        });
        ent.setAttribute("animation__rotate", {
          property: "rotation",
          to: rotTo,
          dur: 1500,
          easing: "easeInOutQuad",
        });
        if (ent.components.sound) ent.components.sound.playSound();
      }

      elk.addEventListener("click", () => {
        animateAndSound(elk, "-1 0 -1", "0 360 0");
      });
      owl.addEventListener("click", () => {
        animateAndSound(owl, "1 2 -3", "0 360 0");
      });
      lady.addEventListener("click", () => {
        animateAndSound(lady, "0 0 -3", "0 -360 0");
      });
    </script>
  </body>
</html>
